# Hybrid Format Overview

This document provides an overview of the hybrid format approach for the Quodsim 2D animation system, which combines core animation files with external visualization configurations.

> **Note:** The Quodsim 2D animation system supports multi-replication output. See [Multi-Replication Structure](./01b_multi_replication_structure.md) for details on how the hybrid format applies to multi-replication simulations.

## Core Animation File + Visualization Files

The Quodsim 2D animation system uses a hybrid format approach:

1. **Core Animation File (`core_animation.json`)**: Contains the essential data for animation, including:
   - Metadata about the simulation
   - Model component definitions (activities, resources, generators, connectors)
   - Entity path data or references to entity path data files
   - Basic visualization settings (`backgroundMode`, `spriteAtlas`, `entityTypes`)
   - References to statistics files
   - References to external visualization files

2. **External Visualization Files**: Contain enhanced visualization configurations:
   - Detailed background settings (as described in `background_configuration.md`)
   - Advanced sprite configurations (as described in `sprite_specifications.md`)
   - Dashboard definitions (as described in `dashboard_definitions.md`)
   - Theme settings
   - Interaction controls

This hybrid approach keeps the core animation file focused on the essential simulation data while allowing for rich visualization options through external configuration files.

## Relationship to Core Animation File Structure

The hybrid format aligns with the structure defined in `01_core_animation_file_structure.md`:

```json
{
  "metadata": { /* ... */ },
  "model": { /* ... */ },
  "entityPathDataFiles": [ /* ... */ ],
  "statisticsDataFiles": [ /* ... */ ],
  "visualization": {
    "backgroundMode": "svg",
    "spriteAtlas": { /* ... */ },
    "entityTypes": { /* ... */ }
  },
  "references": {
    "visualizationFiles": [ /* ... */ ]
  }
}
```

The `references.visualizationFiles` section is the key connection point between the core animation file and extended visualization configurations.

## Benefits of the Hybrid Approach

1. **Separation of Concerns**:
   - Core file focuses on simulation data and basic visualization
   - External files focus on advanced visualization and presentation
   - Statistics files focus on metrics and analysis

2. **Flexibility**:
   - Different visualization configurations can be applied to the same simulation data
   - Visualization settings can be updated without changing the core data

3. **Progressive Enhancement**:
   - Simple animations can use just the core file
   - Advanced visualizations can leverage external configuration files

## File References

The core animation file references external visualization files through the `references` section:

```json
"references": {
  "visualizationFiles": [
    {
      "type": "display",
      "path": "visualization/hospital_er_flow_20250516_rep1_display_config.json"
    }
  ]
}
```

Each referenced file has:
- `type` (string, required): Type of visualization file (e.g., "display", "theme")
- `path` (string, required): Relative path to the visualization file

## Implementation Guidelines

Animation engine implementations should:

1. First load and parse either:
   - The core animation file (for single-replication format)
   - The replication manifest file (for multi-replication format), which will reference shared static files
2. Load any external entity path files referenced in `entityPathDataFiles`
3. Load any statistics files referenced in `statisticsDataFiles`
4. Load any visualization files referenced in `references.visualizationFiles`
5. Apply visualization settings in this order:
   - Basic settings from the core file's `visualization` section
   - Extended settings from external visualization files

This approach ensures that essential animation data is always available while allowing for enhanced visualization through external configurations.

## Example

A minimal setup might include:

- `core_animation.json`: Basic animation data with minimal visualization settings
- `entity_paths/batch_001.json`: Entity path data
- `statistics/act1_queue_length.json`: Queue length statistics for an activity

A comprehensive setup might include:

- `core_animation.json`: Animation data with references to external files
- `entity_paths/`: Multiple entity path batch files
- `statistics/`: Multiple statistics files for different metrics
- `visualization/hospital_er_flow_20250516_rep1_display_config.json`: Advanced display settings with dashboards
- `diagram.svg`: SVG background for the animation

## Animation Engine Output Files

As described in the overview document (`00_overview.md`), the animation files are generated by the Output Product Manager, which processes:

1. The static `model.json` exported from the diagramming tool
2. The dynamic `rep_1_events.csv` generated by the simulation engine

The processing step produces the core animation file and related files, which are then consumed by the web-based animation engine.

## Conclusion

The hybrid format approach provides a flexible, extensible system for 2D animation of simulation data. It allows for simple implementations focused on core functionality while supporting advanced visualization features through external configuration files.
